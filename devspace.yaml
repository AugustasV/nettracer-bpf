version: v1beta11

vars:
- name: APPLICATION
  source: none
  default: "be"  
- name: IMAGE
  source: none
  default: "augustris/nettracer-bpf"
- name: SPACE
  source: none
  default: "default"
pullSecrets:
- registry: hub.docker.com
  username: ${REGISTRY_USERNAME}
  password: ${REGISTRY_PASSWORD}

deployments:
- name: nettracer-test
  # This deployment uses `helm` but you can also define `kubectl` deployments or kustomizations
  helm:
    # We are deploying the so-called Component Chart: https://devspace.sh/component-chart/docs
    componentChart: true
    # Under `values` we can define the values for this Helm chart used during `helm install/upgrade`
    # You may also use `valuesFiles` to load values from files, e.g. valuesFiles: ["values.yaml"]
    values:
      containers:
      - image: image(app):tag(app) # Use the `app` image (see `images`) and the tag DevSpace generates during image building in your Helm values
        command: ["sleep"]
        args: ["9999999"]
      service:
        ports:
        - port: 3000

dependencies:
- name: main-repo
  source:
    git: https://github.com/augustasv/nettracer-bpf
    branch: ${BRANCH}
    cloneArgs:
      - -c
      - core.longpaths=true
  profile: do-not-include-dependencies-and-deployments-and-hooks

hooks:
 - name: helm
   events: ["before:render"]
   command: |
     git clone --depth=1 -b ${BRANCH} https://github.com/augustasv/nettracer-bpf "${DEVSPACE_USER_HOME}/.devspace/dependencies/external/" || cd "${DEVSPACE_USER_HOME}/.devspace/dependencies/external/" && git pull --force
   os: linux,windows
  
commands:
- name: remote-development
  command: "devspace dev -p remote -n ${SPACE} --kube-context ondemand"

profiles:
- name: remote
  replace:
    images:
      default:
        dockerfile: Dockerfile
        context: ../
        image: "${IMAGE}/${APPLICATION}"
        tags:
          - "${DEVSPACE_RANDOM}"
        build:
          docker:
            skipPush: true
            disableFallback: true
            resources:
              limits:
                memory: "512Mi"
                cpu: "500m"
- name: do-not-include-dependencies-and-deployments-and-hooks
  parents: 
  - profile: remote
  patches:
  - op: remove
    path: dependencies.name=main-repo
  - op: remove
    path: hooks.name=helm