version: v1beta11

vars:
- name: APPLICATION
  source: none
  default: "be"  
- name: IMAGE
  source: none
  default: "augustris/nettracer-bpf"
- name: SPACE
  source: none
  default: "default"
- name: BRANCH
  default: "testing"

deployments:
- name: nettracer-test
  helm:
    chart:
      name: ${DEVSPACE_USER_HOME}/nettracer-bpf/helm/nettracer-bpf
    values:
      image:
        repository: ${APPLICATION}/${IMAGE}
        tag: ${DEVSPACE_RANDOM}

dependencies:
- name: main-repo
  source:
    git: https://github.com/augustasv/nettracer-bpf
    branch: ${BRANCH}
    cloneArgs:
      - -c 
      - core.longpaths=true
  profile: do-not-include-dependencies-and-deployments-and-hooks

hooks:
 - name: helm
   events: ["before:render"]
   command: |
     git clone --depth=1 -b master https://github.com/augustasv/nettracer-bpf "${DEVSPACE_USER_HOME}/.devspace/dependencies/external/" || cd "${DEVSPACE_USER_HOME}/.devspace/dependencies/external/" && git pull --force
   os: linux,windows
  
commands:
- name: remote-development
  command: "devspace dev -p remote -n ${SPACE} --kube-context ondemand"

profiles:
- name: remote
  replace:
    images:
      default:
        dockerfile: Dockerfile
        context: ../
        image: "${IMAGE}/${APPLICATION}"
        tags:
          - "${DEVSPACE_RANDOM}"
        build:
          docker:
            skipPush: true
            disableFallback: true
            resources:
              limits:
                memory: "512Mi"
                cpu: "500m"
- name: do-not-include-dependencies-and-deployments-and-hooks
  parents: 
  - profile: remote
  patches:
  - op: remove
    path: dependencies.name=main-repo
  - op: remove
    path: hooks.name=helm